<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compact Note Maker A4</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React и ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Marked (Markdown) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 5. KaTeX (Formulas) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- 6. html2pdf.js (Для прямого экспорта) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* Настройки страницы */
        @page { 
            size: landscape; 
            margin: 0; 
        }
        
        @media print {
            /* Скрываем всё по умолчанию */
            body * {
                visibility: hidden;
            }

            /* Сбрасываем стили контейнеров, чтобы не мешали печати */
            html, body, #root {
                background: white !important;
                height: auto !important;
                overflow: visible !important;
            }

            /* Показываем ТОЛЬКО область печати */
            #printable-root, #printable-root * {
                visibility: visible;
            }

            /* Позиционируем область печати поверх всего */
            #printable-root {
                position: fixed !important;
                left: 0 !important;
                top: 0 !important;
                width: 297mm !important;
                height: 210mm !important;
                margin: 0 !important;
                padding: 0 !important;
                z-index: 99999;
                background: white;
                
                /* Принудительная печать цветов */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        /* Стили Markdown */
        .markdown-body h1 { font-size: 1.2em; font-weight: bold; border-bottom: 1px solid #ddd; margin-top: 0.5em; margin-bottom: 0.2em; break-after: avoid; }
        .markdown-body h2 { font-size: 1.1em; font-weight: bold; background: #f3f4f6; padding: 0 4px; border-radius: 4px; margin-top: 0.5em; margin-bottom: 0.2em; break-after: avoid; }
        .markdown-body h3 { font-size: 1em; font-weight: bold; text-decoration: underline; margin-top: 0.4em; margin-bottom: 0.1em; break-after: avoid; }
        .markdown-body p { margin-bottom: 0.4em; text-align: justify; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.4em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.4em; }
        .markdown-body li { margin-bottom: 0.1em; }
        .markdown-body code { background: #f3f4f6; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em; border: 1px solid #e5e7eb; }
        .markdown-body pre { background: #f3f4f6; padding: 8px; border-radius: 4px; overflow-x: auto; margin-bottom: 0.4em; border: 1px solid #e5e7eb; break-inside: avoid; }
        .markdown-body pre code { background: none; padding: 0; border: none; }
        .markdown-body blockquote { border-left: 3px solid #d1d5db; padding-left: 10px; color: #4b5563; font-style: italic; margin: 0.4em 0; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin-bottom: 0.4em; font-size: 0.9em; break-inside: avoid; }
        .markdown-body th, .markdown-body td { border: 1px solid #d1d5db; padding: 4px; }
        .markdown-body th { background: #f9fafb; font-weight: bold; }
        
        .katex { font-size: 1.1em; }
        .katex-display { margin: 0.5em 0; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-gray-800">

<div id="root" class="h-full"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Иконки
    const IconPrinter = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>;
    const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
    const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
    const IconFileText = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>;
    
    const App = () => {
        const defaultText = `# Шпаргалка

### Формулы (LaTeX)
Закон Ома: $$ I = \\frac{U}{R} $$
Матрица:
$$ \\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} $$

### Markdown
* **Жирный** и *Курсив*
* \`Код\` внутри строки

\`\`\`js
console.log("Печать цветов работает!");
\`\`\`

1. Пункт один
2. Пункт два
`;

        const [text, setText] = useState(defaultText);
        const [columns, setColumns] = useState(3);
        const [fontSize, setFontSize] = useState(9);
        const [lineHeight, setLineHeight] = useState(1.2);
        const [columnGap, setColumnGap] = useState(5);
        const [padding, setPadding] = useState(5);
        const [showSettings, setShowSettings] = useState(true);
        const [previewHtml, setPreviewHtml] = useState("");
        const [isGenerating, setIsGenerating] = useState(false);
        const previewRef = useRef(null);

        useEffect(() => {
            if (window.marked) {
                const rawHtml = window.marked.parse(text);
                setPreviewHtml(rawHtml);
            }
        }, [text]);

        useEffect(() => {
            if (previewRef.current && window.renderMathInElement) {
                window.renderMathInElement(previewRef.current, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }, [previewHtml, columns, fontSize, padding]);

        // Стандартная печать (Векторный PDF)
        const handlePrint = () => {
            window.print();
        };

        // Прямая генерация (Растровый снимок - улучшено качество)
        const handleDirectDownload = () => {
            if (!window.html2pdf) {
                alert("Библиотека PDF еще загружается, подождите секунду...");
                return;
            }

            setIsGenerating(true);
            const element = document.getElementById('printable-content');
            
            // Опции: увеличен масштаб (scale) с 2 до 4 для четкости
            const opt = {
                margin: 0,
                filename: 'cheatsheet_a4.pdf',
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { 
                    scale: 4, // Высокое качество (но все равно растр)
                    useCORS: true,
                    logging: false
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };

            window.html2pdf().set(opt).from(element).save().then(() => {
                setIsGenerating(false);
            }).catch(err => {
                console.error(err);
                setIsGenerating(false);
                alert("Ошибка генерации. Попробуйте кнопку 'Печать' для вектора.");
            });
        };

        return (
            <div className="flex flex-col h-screen overflow-hidden">
                {/* HEADER */}
                <header className="flex-none bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between shadow-sm z-20 print:hidden">
                    <div className="flex items-center gap-2">
                        <div className="text-blue-600"><IconFileText /></div>
                        <h1 className="text-xl font-bold text-gray-800">Compact<span className="text-blue-600">Sheet</span> A4</h1>
                    </div>
                    <div className="flex items-center gap-2">
                        <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-lg transition-colors flex items-center gap-2 ${showSettings ? 'bg-blue-50 text-blue-600' : 'hover:bg-gray-100'}`}>
                            <IconSettings /> <span className="hidden sm:inline">Параметры</span>
                        </button>
                        
                        <div className="h-6 w-px bg-gray-300 mx-1"></div>

                        <button 
                            onClick={handlePrint} 
                            className="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm text-sm"
                            title="Стандартная печать браузера (Лучшее качество - Вектор)"
                        >
                            <IconPrinter /> <span>Печать (Вектор)</span>
                        </button>
                        
                        <button 
                            onClick={handleDirectDownload} 
                            disabled={isGenerating}
                            className={`bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm text-sm ${isGenerating ? 'opacity-50 cursor-not-allowed' : ''}`}
                            title="Сохранить как картинку в PDF"
                        >
                            <IconDownload /> <span>{isGenerating ? 'Генерация...' : 'Снимок PDF'}</span>
                        </button>
                    </div>
                </header>

                <div className="flex flex-1 overflow-hidden relative">
                    {/* SETTINGS SIDEBAR */}
                    {showSettings && (
                        <aside className="w-64 bg-white border-r border-gray-200 overflow-y-auto p-4 flex-none z-10 print:hidden shadow-lg absolute md:relative h-full">
                            <h3 className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Разметка</h3>
                            <div className="space-y-5">
                                <div className="space-y-1">
                                    <div className="flex justify-between"><label className="text-sm font-medium text-gray-600">Колонки</label><span className="text-xs bg-gray-100 px-2 py-0.5 rounded font-mono">{columns}</span></div>
                                    <input type="range" min="1" max="5" step="1" value={columns} onChange={(e) => setColumns(Number(e.target.value))} className="w-full accent-blue-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
                                </div>
                                <div className="space-y-1">
                                    <div className="flex justify-between"><label className="text-sm font-medium text-gray-600">Размер шрифта</label><span className="text-xs bg-gray-100 px-2 py-0.5 rounded font-mono">{fontSize}pt</span></div>
                                    <input type="range" min="4" max="16" step="0.5" value={fontSize} onChange={(e) => setFontSize(Number(e.target.value))} className="w-full accent-blue-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
                                </div>
                                <div className="space-y-1">
                                    <div className="flex justify-between"><label className="text-sm font-medium text-gray-600">Интерлиньяж</label><span className="text-xs bg-gray-100 px-2 py-0.5 rounded font-mono">{lineHeight}</span></div>
                                    <input type="range" min="0.8" max="2.0" step="0.05" value={lineHeight} onChange={(e) => setLineHeight(Number(e.target.value))} className="w-full accent-blue-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
                                </div>
                                <div className="space-y-1">
                                    <div className="flex justify-between"><label className="text-sm font-medium text-gray-600">Отступ колонок</label><span className="text-xs bg-gray-100 px-2 py-0.5 rounded font-mono">{columnGap}mm</span></div>
                                    <input type="range" min="1" max="20" step="1" value={columnGap} onChange={(e) => setColumnGap(Number(e.target.value))} className="w-full accent-blue-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
                                </div>
                                <div className="space-y-1">
                                    <div className="flex justify-between"><label className="text-sm font-medium text-gray-600">Поля листа</label><span className="text-xs bg-gray-100 px-2 py-0.5 rounded font-mono">{padding}mm</span></div>
                                    <input type="range" min="0" max="30" step="1" value={padding} onChange={(e) => setPadding(Number(e.target.value))} className="w-full accent-blue-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
                                </div>
                            </div>
                        </aside>
                    )}

                    {/* MAIN CONTENT */}
                    <main className="flex-1 flex flex-col md:flex-row h-full overflow-hidden bg-gray-100">
                        {/* EDITOR */}
                        <div className="flex-1 flex flex-col min-h-[300px] border-r border-gray-200 print:hidden">
                            <div className="bg-gray-50 px-4 py-2 border-b border-gray-200 text-xs font-semibold text-gray-500 uppercase flex justify-between">
                                <span>Редактор</span>
                                <span className="text-gray-400 text-[10px] mt-0.5">Markdown + LaTeX</span>
                            </div>
                            <textarea 
                                value={text} 
                                onChange={(e) => setText(e.target.value)} 
                                className="flex-1 p-4 resize-none focus:outline-none font-mono text-sm leading-relaxed"
                                placeholder="Введите текст шпаргалки..."
                            />
                        </div>

                        {/* PREVIEW A4 */}
                        <div className="flex-1 bg-gray-500/10 overflow-auto p-4 md:p-8 flex justify-center items-start print:p-0 print:overflow-visible print:bg-white print:block">
                            {/* Обертка для позиционирования при печати */}
                            <div id="printable-root">
                                <div 
                                    id="printable-content"
                                    className="bg-white shadow-xl print:shadow-none mx-auto print:mx-0 origin-top"
                                    style={{
                                        width: '297mm',
                                        height: '210mm',
                                        padding: `${padding}mm`,
                                        fontSize: `${fontSize}pt`,
                                        lineHeight: lineHeight,
                                        boxSizing: 'border-box'
                                    }}
                                >
                                    <div 
                                        className="h-full w-full markdown-body"
                                        ref={previewRef}
                                        style={{
                                            columnCount: columns,
                                            columnGap: `${columnGap}mm`,
                                            columnFill: 'auto',
                                            height: '100%'
                                        }}
                                        dangerouslySetInnerHTML={{ __html: previewHtml }}
                                    />
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>
